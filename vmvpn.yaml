vmType: "qemu"

images:
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-amd64.img"
    arch: "x86_64"
  - location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"
    arch: "aarch64"

cpus: 2
memory: "4GiB"
disk: "20GiB"

mounts: []

containerd:
  system: false
  user: false

provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail

      apt-get update
      apt-get install -y \
        curl \
        wget \
        net-tools \
        iputils-ping \
        iproute2 \
        ca-certificates \
        gnupg \
        vim \
        less \
        htop \
        expect

      # Install FortiClient VPN-only (free standalone version from official Fortinet download)
      # https://www.fortinet.com/support/product-downloads -> FortiClient VPN-only -> Linux .deb
      wget -O /tmp/forticlient-vpn.deb 'https://links.fortinet.com/forticlient/deb/vpnagent'
      dpkg -i /tmp/forticlient-vpn.deb || apt-get install -f -y
      rm /tmp/forticlient-vpn.deb

      # Install and configure Squid proxy
      apt-get install -y squid

      cat > /etc/squid/conf.d/vpn-proxy.conf << 'SQUIDCONF'
      # Only allow localhost connections
      acl localhost src 127.0.0.1/32
      acl localhost src ::1

      # Allow SSL ports
      acl SSL_ports port 443
      acl Safe_ports port 80
      acl Safe_ports port 443
      acl Safe_ports port 8080
      acl Safe_ports port 8443

      # Allow CONNECT for SSL
      acl CONNECT method CONNECT

      # Access rules - localhost only
      http_access allow localhost
      http_access deny all

      # Listen on localhost only, port 3128
      http_port 127.0.0.1:3128

      # Disable caching (we just want to proxy)
      cache deny all

      # Anonymous proxy - hide all proxy-related headers
      via off
      forwarded_for delete
      request_header_access Via deny all
      request_header_access X-Forwarded-For deny all
      request_header_access Proxy-Connection deny all
      reply_header_access Via deny all
      reply_header_access X-Cache deny all
      reply_header_access X-Cache-Lookup deny all

      # WebSocket support - allow upgrade headers
      request_header_access Upgrade allow all
      request_header_access Connection allow all
      request_header_access Sec-WebSocket-Key allow all
      request_header_access Sec-WebSocket-Version allow all
      request_header_access Sec-WebSocket-Extensions allow all
      request_header_access Sec-WebSocket-Protocol allow all
      reply_header_access Upgrade allow all
      reply_header_access Connection allow all
      reply_header_access Sec-WebSocket-Accept allow all
      SQUIDCONF

      systemctl enable squid
      systemctl restart squid

probes:
  - script: |
      #!/bin/bash
      set -eux -o pipefail
      if ! timeout 30s bash -c "until command -v curl >/dev/null 2>&1; do sleep 3; done"; then
        echo >&2 "curl is not installed yet"
        exit 1
      fi
    hint: Waiting for provisioning to complete

hostResolver:
  enabled: true
  hosts:
    host.lima.internal: host.lima.internal

networks:
  - lima: user-v2

message: |
  Ubuntu 24.04 LTS VM for FortiClient VPN is ready!
  
  To access the VM:
    limactl shell ubuntu-vpn
  
  Or via SSH:
    ssh -F ~/.lima/ubuntu-vpn/ssh.config lima-ubuntu-vpn
